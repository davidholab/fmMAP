# fmMAP: A Framework Reducing Site-Bias Batch Effect from Foundation Models in Pathology

We propose a Foundation Model-based Manifold Approximation Pipeline (fmMAP) to reduce the batch effect by adjusting features from FMs. Our framework employs supervised uniform manifold approximation (UMAP) to transform features generated by FMs into an optimal space. In this transformed space, characteristics of features of interest (i.e., biological features) are highlighted while other confounding factors are reduced.

<img src="./fig/bcss_accuracy_v3.png" alt="fmMAP Performance">

## Prerequisites
* Python 3.6 or greater
* numpy
* scipy
* umap 
* scikit-learn* 
* matplotlib

## Foundation Models (FMs)
You can find the tutorials and pretrained FMs at their HuggingFace:
* [UNI-2h](https://huggingface.co/MahmoodLab/UNI2-h)
* [UNI](https://huggingface.co/MahmoodLab/UNI)
* [Virchow](https://huggingface.co/paige-ai/Virchow)
* [Virchow2](https://huggingface.co/paige-ai/Virchow2)
* [H-Optimus-0](https://huggingface.co/bioptimus/H-optimus-0)
* [Prov-GigaPath](https://huggingface.co/prov-gigapath/prov-gigapath)
* [Phikon](https://huggingface.co/owkin/phikon)
* [Phikon-v2](https://huggingface.co/owkin/phikon-v2)

## Notebooks
A collection of notebooks for applying and testing fmMAP.

* [Notebook-1](./notebooks/1%20-%20FM-feature_Extract_and_Site_Tracking_UNI2h.ipynb) extracts and uses FM features for site tracking with UNI-2h.
* [Notebook-2](./notebooks/2%20-%20fmMAP-Feature_Generate_and_Compare_to_FM_UNI2h.ipynb) generates fmMAP features and shows the performance improvements with UNI-2h.
* [Notebook-3](./notebooks/3%20-%20Five-Fold_Cross_Validation_Performance_Test.ipynb) shows our five-fold cross-validation test.
* [Notebook-4](./notebooks/4%20-%20Robustness_Index_Calculating.ipynb) calculates Robustness Index for FMs.
* [Notebook-5](./notebooks/5%20-%20Figure_Builder.ipynb) plots some figures in our articles.

## Acknowledgments
* Our analysis is based on [UNI](https://github.com/mahmoodlab/UNI) guidelines.
* This code is based on [UMAP](https://github.com/lmcinnes/umap).

## Reference
If you find our work useful, please cite our [paper](./README.md):
```
@article{ho2025,
  title={fmMAP: A Framework Reducing Site-Bias Batch Effect from Foundation Models in Pathology},
  author={Nguyen, Cao Truong Hai and Ho, David Joon},
  year={2025}
}
```
